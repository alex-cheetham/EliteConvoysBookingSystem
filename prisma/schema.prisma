generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum BookingStatus {
  REQUESTED
  REVIEW
  ACCEPTED
  DECLINED
  CANCELLED
  COMPLETED
}

model GuildConfig {
  id                    String   @id
  staffRoleId           String?
  ticketCategoryPrefix  String   @default("Convoys")
  defaultEventDurationM Int      @default(90)
  bufferTimeM           Int      @default(15)
  reviewMode            Boolean  @default(false)
  realOpsWarning        Boolean  @default(false)
  remindersEnabled      Boolean  @default(true)
  reminderMinutesCsv    String   @default("1440,120,30") // 24h,2h,30m
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Booking {
  id               String        @id @default(cuid())
  guildId          String
  requesterId      String
  requesterTag     String
  vtcName          String
  eventDate        String        // YYYY-MM-DD (UTC)
  meetupTime       String        // HH:mm (UTC)
  departureTime    String        // HH:mm (UTC)
  serverName       String
  startLocation    String
  destination      String
  requiredDlcs     String
  tmpEventLink     String
  notes            String?
  internalNotes    String?
  realOpsAttending Boolean       @default(false)

  status           BookingStatus @default(REQUESTED)
  statusHistory    String        @default("[]") // JSON array of {status, at, by}

  // NEW: required (by UI) when staff declines, and auto-set when auto-declined by a closure
  declineReason         String?
  // NEW: optional helper for auditing ("STAFF" or "CLOSURE" etc.)
  declineReasonSource   String?

  ticketChannelId  String?
  ticketCategoryId String?
  acceptanceSent   Boolean       @default(false)

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([guildId, status])
}

//
// Keep DB name as Blackout, but we will rename it in the WEB UI to "Closures".
// This avoids a risky rename migration on SQLite.
//
model Blackout {
  id        String   @id @default(cuid())
  guildId   String
  startUtc  DateTime
  endUtc    DateTime
  reason    String?
  createdAt DateTime @default(now())

  @@index([guildId, startUtc, endUtc])
}

model ReminderLog {
  id         String   @id @default(cuid())
  bookingId  String
  minutes    Int
  sentAt     DateTime @default(now())

  @@unique([bookingId, minutes])
}

model BookingDraft {
  id          String   @id @default(cuid())
  guildId     String
  userId      String
  payloadJson String
  createdAt   DateTime @default(now())

  @@index([guildId, userId])
}
